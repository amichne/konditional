name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write
  packages: write

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'gradle'

      - name: Validate version matches tag
        run: |
          TAG_VERSION="${GITHUB_REF#refs/tags/v}"
          GRADLE_VERSION=$(./gradlew properties -q | grep "^version:" | awk '{print $2}')

          echo "Tag version: $TAG_VERSION"
          echo "Gradle version: $GRADLE_VERSION"

          if [ "$TAG_VERSION" != "$GRADLE_VERSION" ]; then
            echo "ERROR: Version mismatch between tag ($TAG_VERSION) and gradle.properties ($GRADLE_VERSION)"
            exit 1
          fi

          echo "âœ“ Version validated: $TAG_VERSION"

      - name: Run tests
        run: ./gradlew test --no-daemon

  publish-maven-central:
    runs-on: ubuntu-latest
    needs: validate
    outputs:
      published: ${{ steps.gate.outputs.publish }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'gradle'

      - name: Check Maven Central + signing secrets
        id: gate
        run: |
          missing=0

          if [ -z "${{ secrets.ORG_GRADLE_PROJECT_MAVENCENTRALUSERNAME }}" ]; then
            echo "Missing ORG_GRADLE_PROJECT_MAVENCENTRALUSERNAME secret"
            missing=1
          fi
          if [ -z "${{ secrets.ORG_GRADLE_PROJECT_MAVENCENTRALPASSWORD }}" ]; then
            echo "Missing ORG_GRADLE_PROJECT_MAVENCENTRALPASSWORD secret"
            missing=1
          fi
          if [ -z "${{ secrets.SIGNING_GPG_KEY_NAME }}" ]; then
            echo "Missing SIGNING_GPG_KEY_NAME secret"
            missing=1
          fi
          if [ -z "${{ secrets.SIGNING_GPG_PRIVATE_KEY }}" ]; then
            echo "Missing SIGNING_GPG_PRIVATE_KEY secret"
            missing=1
          fi

          if [ "$missing" -eq 1 ]; then
            echo "publish=false" >> "$GITHUB_OUTPUT"
            echo "Maven Central publish skipped due to missing secrets."
          else
            echo "publish=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Import GPG key
        if: steps.gate.outputs.publish == 'true'
        env:
          SIGNING_GPG_PRIVATE_KEY: ${{ secrets.SIGNING_GPG_PRIVATE_KEY }}
          SIGNING_GPG_KEY_NAME: ${{ secrets.SIGNING_GPG_KEY_NAME }}
        run: |
          if ! printf '%s' "$SIGNING_GPG_PRIVATE_KEY" | gpg --batch --import; then
            if ! printf '%s' "$SIGNING_GPG_PRIVATE_KEY" | base64 --decode | gpg --batch --import; then
              echo "Failed to import SIGNING_GPG_PRIVATE_KEY as armored or base64-encoded key material"
              exit 1
            fi
          fi
          if ! gpg --list-secret-keys --keyid-format=long "$SIGNING_GPG_KEY_NAME"; then
            echo "Imported key material does not contain a secret key for SIGNING_GPG_KEY_NAME=$SIGNING_GPG_KEY_NAME"
            exit 1
          fi

      - name: Publish to Maven Central
        if: steps.gate.outputs.publish == 'true'
        env:
          ORG_GRADLE_PROJECT_mavenCentralUsername: ${{ secrets.ORG_GRADLE_PROJECT_MAVENCENTRALUSERNAME }}
          ORG_GRADLE_PROJECT_mavenCentralPassword: ${{ secrets.ORG_GRADLE_PROJECT_MAVENCENTRALPASSWORD }}
          SIGNING_GPG_KEY_NAME: ${{ secrets.SIGNING_GPG_KEY_NAME }}
          SIGNING_GPG_PASSPHRASE: ${{ secrets.SIGNING_GPG_PASSPHRASE }}
        run: |
          SIGNING_ARGS=(-Psigning.gnupg.keyName="$SIGNING_GPG_KEY_NAME")
          if [ -n "${SIGNING_GPG_PASSPHRASE:-}" ]; then
            SIGNING_ARGS+=(-Psigning.gnupg.passphrase="$SIGNING_GPG_PASSPHRASE")
          fi

          ./gradlew publishAndReleaseToMavenCentral "${SIGNING_ARGS[@]}" \
            --no-configuration-cache \
            --no-daemon \
            --stacktrace

  publish-github-packages:
    runs-on: ubuntu-latest
    needs: validate
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'gradle'

      - name: Require signing secrets
        run: |
          if [ -z "${{ secrets.SIGNING_GPG_PRIVATE_KEY }}" ]; then
            echo "Missing SIGNING_GPG_PRIVATE_KEY secret"
            exit 1
          fi
          if [ -z "${{ secrets.SIGNING_GPG_KEY_NAME }}" ]; then
            echo "Missing SIGNING_GPG_KEY_NAME secret"
            exit 1
          fi

      - name: Import GPG key
        env:
          SIGNING_GPG_PRIVATE_KEY: ${{ secrets.SIGNING_GPG_PRIVATE_KEY }}
          SIGNING_GPG_KEY_NAME: ${{ secrets.SIGNING_GPG_KEY_NAME }}
        run: |
          if ! printf '%s' "$SIGNING_GPG_PRIVATE_KEY" | gpg --batch --import; then
            if ! printf '%s' "$SIGNING_GPG_PRIVATE_KEY" | base64 --decode | gpg --batch --import; then
              echo "Failed to import SIGNING_GPG_PRIVATE_KEY as armored or base64-encoded key material"
              exit 1
            fi
          fi
          if ! gpg --list-secret-keys --keyid-format=long "$SIGNING_GPG_KEY_NAME"; then
            echo "Imported key material does not contain a secret key for SIGNING_GPG_KEY_NAME=$SIGNING_GPG_KEY_NAME"
            exit 1
          fi

      - name: Publish to GitHub Packages
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_ACTOR: ${{ github.actor }}
          SIGNING_GPG_KEY_NAME: ${{ secrets.SIGNING_GPG_KEY_NAME }}
          SIGNING_GPG_PASSPHRASE: ${{ secrets.SIGNING_GPG_PASSPHRASE }}
        run: |
          SIGNING_ARGS=(-Psigning.gnupg.keyName="$SIGNING_GPG_KEY_NAME")
          if [ -n "${SIGNING_GPG_PASSPHRASE:-}" ]; then
            SIGNING_ARGS+=(-Psigning.gnupg.passphrase="$SIGNING_GPG_PASSPHRASE")
          fi

          ./gradlew publishMavenPublicationToGitHubPackagesRepository "${SIGNING_ARGS[@]}" \
            --no-configuration-cache \
            --no-daemon \
            --stacktrace

  create-github-release:
    runs-on: ubuntu-latest
    needs: [ validate, publish-maven-central, publish-github-packages ]
    if: >
      always() &&
      needs.validate.result == 'success' &&
      needs.publish-github-packages.result == 'success' &&
      (needs.publish-maven-central.result == 'success' || needs.publish-maven-central.outputs.published == 'false')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'gradle'

      - name: Build release artifacts
        run: |
          ./gradlew assemble --no-daemon
          rm -rf release-artifacts
          mkdir -p release-artifacts
          find . -type f -path "*/build/libs/*.jar" \
            ! -path "./build-logic/*" \
            ! -path "./detekt-rules/*" \
            -exec cp {} release-artifacts/ \;
          if [ -z "$(find release-artifacts -maxdepth 1 -name '*.jar' -print -quit)" ]; then
            echo "No release artifacts found in module build/libs directories"
            exit 1
          fi
          (
            cd release-artifacts
            sha256sum *.jar > SHA256SUMS.txt
          )

      - name: Extract version
        id: version
        run: |
          VERSION="${GITHUB_REF#refs/tags/v}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      - name: Generate changelog
        id: changelog
        run: |
          # Get the previous tag
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")

          if [ -z "$PREV_TAG" ]; then
            echo "First release - including all commits"
            CHANGELOG=$(git log --pretty=format:"- %s (%h)" --no-merges)
          else
            echo "Changes since $PREV_TAG"
            CHANGELOG=$(git log ${PREV_TAG}..HEAD --pretty=format:"- %s (%h)" --no-merges)
          fi

          # Save to file for multiline output
          echo "$CHANGELOG" > changelog.txt

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: Release v${{ steps.version.outputs.version }}
          body_path: changelog.txt
          draft: false
          prerelease: ${{ contains(steps.version.outputs.version, 'alpha') || contains(steps.version.outputs.version, 'beta') || contains(steps.version.outputs.version, 'rc') }}
          files: |
            release-artifacts/*.jar
            release-artifacts/SHA256SUMS.txt
          fail_on_unmatched_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create Maven Central announcement
        if: needs.publish-maven-central.outputs.published == 'true'
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          cat << EOF > maven-central-notice.txt

          ðŸŽ‰ Published to Maven Central!

          Add to your project:

          Gradle (Kotlin DSL):
          \`\`\`kotlin
          dependencies {
              implementation("io.amichne:konditional:$VERSION")
          }
          \`\`\`

          Gradle (Groovy DSL):
          \`\`\`groovy
          dependencies {
              implementation 'io.amichne:konditional:$VERSION'
          }
          \`\`\`

          Maven:
          \`\`\`xml
          <dependency>
              <groupId>io.amichne</groupId>
              <artifactId>konditional</artifactId>
              <version>$VERSION</version>
          </dependency>
          \`\`\`

          Note: It may take up to 2 hours for the release to appear in Maven Central.
          EOF

          cat maven-central-notice.txt

      - name: Upload Maven Central notice
        if: needs.publish-maven-central.outputs.published == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: maven-central-notice
          path: maven-central-notice.txt
