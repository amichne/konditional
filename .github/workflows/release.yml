name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write
  packages: write

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'gradle'

      - name: Validate version matches tag
        run: |
          TAG_VERSION="${GITHUB_REF#refs/tags/v}"
          GRADLE_VERSION=$(./gradlew properties -q | grep "^version:" | awk '{print $2}')

          echo "Tag version: $TAG_VERSION"
          echo "Gradle version: $GRADLE_VERSION"

          if [ "$TAG_VERSION" != "$GRADLE_VERSION" ]; then
            echo "ERROR: Version mismatch between tag ($TAG_VERSION) and gradle.properties ($GRADLE_VERSION)"
            exit 1
          fi

          echo "âœ“ Version validated: $TAG_VERSION"

      - name: Run tests
        run: ./gradlew test --no-daemon

  publish-maven-central:
    runs-on: ubuntu-latest
    needs: validate
    if: secrets.OSSRH_USERNAME != '' && secrets.OSSRH_PASSWORD != ''
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'gradle'

      - name: Require signing secrets
        run: |
          if [ -z "${{ secrets.SIGNING_GPG_PRIVATE_KEY }}" ]; then
            echo "Missing SIGNING_GPG_PRIVATE_KEY secret"
            exit 1
          fi
          if [ -z "${{ secrets.SIGNING_GPG_KEY_NAME }}" ]; then
            echo "Missing SIGNING_GPG_KEY_NAME secret"
            exit 1
          fi

      - name: Import GPG key
        env:
          SIGNING_GPG_PRIVATE_KEY: ${{ secrets.SIGNING_GPG_PRIVATE_KEY }}
        run: |
          echo "$SIGNING_GPG_PRIVATE_KEY" | gpg --batch --import
          gpg --list-secret-keys --keyid-format=long

      - name: Publish to Maven Central
        env:
          OSSRH_USERNAME: ${{ secrets.OSSRH_USERNAME }}
          OSSRH_PASSWORD: ${{ secrets.OSSRH_PASSWORD }}
          SIGNING_GPG_KEY_NAME: ${{ secrets.SIGNING_GPG_KEY_NAME }}
          ORG_GRADLE_PROJECT_signing.gnupg.keyName: ${{ secrets.SIGNING_GPG_KEY_NAME }}
          ORG_GRADLE_PROJECT_signing.gnupg.passphrase: ${{ secrets.SIGNING_GPG_PASSPHRASE }}
        run: |
          ./gradlew publishToSonatype closeAndReleaseSonatypeStagingRepository \
            --no-daemon \
            --stacktrace

  publish-github-packages:
    runs-on: ubuntu-latest
    needs: validate
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'gradle'

      - name: Require signing secrets
        run: |
          if [ -z "${{ secrets.SIGNING_GPG_PRIVATE_KEY }}" ]; then
            echo "Missing SIGNING_GPG_PRIVATE_KEY secret"
            exit 1
          fi
          if [ -z "${{ secrets.SIGNING_GPG_KEY_NAME }}" ]; then
            echo "Missing SIGNING_GPG_KEY_NAME secret"
            exit 1
          fi

      - name: Import GPG key
        env:
          SIGNING_GPG_PRIVATE_KEY: ${{ secrets.SIGNING_GPG_PRIVATE_KEY }}
        run: |
          echo "$SIGNING_GPG_PRIVATE_KEY" | gpg --batch --import
          gpg --list-secret-keys --keyid-format=long

      - name: Publish to GitHub Packages
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_ACTOR: ${{ github.actor }}
          SIGNING_GPG_KEY_NAME: ${{ secrets.SIGNING_GPG_KEY_NAME }}
          ORG_GRADLE_PROJECT_signing.gnupg.keyName: ${{ secrets.SIGNING_GPG_KEY_NAME }}
          ORG_GRADLE_PROJECT_signing.gnupg.passphrase: ${{ secrets.SIGNING_GPG_PASSPHRASE }}
        run: |
          ./gradlew publishMavenPublicationToGitHubPackagesRepository \
            --no-daemon \
            --stacktrace

  create-github-release:
    runs-on: ubuntu-latest
    needs: [ validate, publish-maven-central, publish-github-packages ]
    if: >
      always() &&
      needs.validate.result == 'success' &&
      needs.publish-github-packages.result == 'success' &&
      (needs.publish-maven-central.result == 'success' || needs.publish-maven-central.result == 'skipped')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'gradle'

      - name: Build release artifacts
        run: |
          ./gradlew assemble --no-daemon
          cd build/libs
          sha256sum *.jar > SHA256SUMS.txt

      - name: Extract version
        id: version
        run: |
          VERSION="${GITHUB_REF#refs/tags/v}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      - name: Generate changelog
        id: changelog
        run: |
          # Get the previous tag
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")

          if [ -z "$PREV_TAG" ]; then
            echo "First release - including all commits"
            CHANGELOG=$(git log --pretty=format:"- %s (%h)" --no-merges)
          else
            echo "Changes since $PREV_TAG"
            CHANGELOG=$(git log ${PREV_TAG}..HEAD --pretty=format:"- %s (%h)" --no-merges)
          fi

          # Save to file for multiline output
          echo "$CHANGELOG" > changelog.txt

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: Release v${{ steps.version.outputs.version }}
          body_path: changelog.txt
          draft: false
          prerelease: ${{ contains(steps.version.outputs.version, 'alpha') || contains(steps.version.outputs.version, 'beta') || contains(steps.version.outputs.version, 'rc') }}
          files: |
            build/libs/*.jar
            build/libs/SHA256SUMS.txt
          fail_on_unmatched_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create Maven Central announcement
        if: needs.publish-maven-central.result == 'success'
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          cat << EOF > maven-central-notice.txt

          ðŸŽ‰ Published to Maven Central!

          Add to your project:

          Gradle (Kotlin DSL):
          \`\`\`kotlin
          dependencies {
              implementation("io.amichne:konditional:$VERSION")
          }
          \`\`\`

          Gradle (Groovy DSL):
          \`\`\`groovy
          dependencies {
              implementation 'io.amichne:konditional:$VERSION'
          }
          \`\`\`

          Maven:
          \`\`\`xml
          <dependency>
              <groupId>io.amichne</groupId>
              <artifactId>konditional</artifactId>
              <version>$VERSION</version>
          </dependency>
          \`\`\`

          Note: It may take up to 2 hours for the release to appear in Maven Central.
          EOF

          cat maven-central-notice.txt

      - name: Upload Maven Central notice
        if: needs.publish-maven-central.result == 'success'
        uses: actions/upload-artifact@v4
        with:
          name: maven-central-notice
          path: maven-central-notice.txt
