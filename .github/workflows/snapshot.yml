name: Publish Snapshot

on:
  workflow_dispatch:
    inputs:
      snapshot-version:
        description: 'Snapshot version (e.g., 0.1.0-SNAPSHOT)'
        required: true
        type: string

permissions:
  contents: read
  packages: write

jobs:
  publish-snapshot:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'gradle'

      - name: Require signing secrets
        run: |
          if [ -z "${{ secrets.SIGNING_GPG_PRIVATE_KEY }}" ]; then
            echo "Missing SIGNING_GPG_PRIVATE_KEY secret"
            exit 1
          fi
          if [ -z "${{ secrets.SIGNING_GPG_KEY_NAME }}" ]; then
            echo "Missing SIGNING_GPG_KEY_NAME secret"
            exit 1
          fi

      - name: Import GPG key
        env:
          SIGNING_GPG_PRIVATE_KEY: ${{ secrets.SIGNING_GPG_PRIVATE_KEY }}
        run: |
          echo "$SIGNING_GPG_PRIVATE_KEY" | gpg --batch --import
          gpg --list-secret-keys --keyid-format=long

      - name: Validate snapshot version
        run: |
          VERSION="${{ github.event.inputs.snapshot-version }}"
          if [[ ! "$VERSION" =~ -SNAPSHOT$ ]]; then
            echo "ERROR: Version must end with -SNAPSHOT"
            exit 1
          fi
          echo "âœ“ Valid snapshot version: $VERSION"

      - name: Override version
        run: |
          VERSION="${{ github.event.inputs.snapshot-version }}"
          echo "Overriding version to: $VERSION"
          sed -i.bak "s/^VERSION=.*/VERSION=$VERSION/" gradle.properties
          cat gradle.properties | grep VERSION

      - name: Run tests
        run: ./gradlew test --no-daemon

      - name: Publish to GitHub Packages
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_ACTOR: ${{ github.actor }}
          SIGNING_GPG_KEY_NAME: ${{ secrets.SIGNING_GPG_KEY_NAME }}
          ORG_GRADLE_PROJECT_signing.gnupg.keyName: ${{ secrets.SIGNING_GPG_KEY_NAME }}
          ORG_GRADLE_PROJECT_signing.gnupg.passphrase: ${{ secrets.SIGNING_GPG_PASSPHRASE }}
        run: |
          ./gradlew publishMavenPublicationToGitHubPackagesRepository \
            --no-daemon \
            --stacktrace

      - name: Summary
        run: |
          VERSION="${{ github.event.inputs.snapshot-version }}"
          cat << EOF >> $GITHUB_STEP_SUMMARY
          ## Snapshot Published 

          **Version:** \`$VERSION\`

          dependencies {
              implementation("io.amichne:konditional:$VERSION")
          }
          \`\`\`

          ### GitHub Packages
          \`\`\`kotlin
          repositories {
              maven {
                  url = uri("https://maven.pkg.github.com/amichne/konditional")
                  credentials {
                      username = project.findProperty("gpr.user") as String? ?: System.getenv("USERNAME")
                      password = project.findProperty("gpr.key") as String? ?: System.getenv("TOKEN")
                  }
              }
          }

          dependencies {
              implementation("io.amichne:konditional:$VERSION")
          }
          \`\`\`
          EOF
