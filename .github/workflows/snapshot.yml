name: Publish Snapshot

on:
  workflow_dispatch:
    inputs:
      snapshot-version:
        description: 'Snapshot version (e.g., 0.1.0-SNAPSHOT)'
        required: true
        type: string

concurrency:
  group: snapshot-${{ github.event.inputs.snapshot-version }}
  cancel-in-progress: false

permissions:
  contents: read
  packages: write

jobs:
  publish-snapshot:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'gradle'

      - name: Require signing secrets
        run: |
          if [ -z "${{ secrets.SIGNING_GPG_PRIVATE_KEY }}" ]; then
            echo "Missing SIGNING_GPG_PRIVATE_KEY secret"
            exit 1
          fi
          if [ -z "${{ secrets.SIGNING_GPG_KEY_NAME }}" ]; then
            echo "Missing SIGNING_GPG_KEY_NAME secret"
            exit 1
          fi

      - name: Import GPG key
        env:
          SIGNING_GPG_PRIVATE_KEY: ${{ secrets.SIGNING_GPG_PRIVATE_KEY }}
        run: |
          echo "$SIGNING_GPG_PRIVATE_KEY" | gpg --batch --import
          gpg --list-secret-keys --keyid-format=long

      - name: Validate snapshot version
        run: |
          VERSION="${{ github.event.inputs.snapshot-version }}"
          if [[ ! "$VERSION" =~ -SNAPSHOT$ ]]; then
            echo "ERROR: Version must end with -SNAPSHOT"
            exit 1
          fi
          echo "âœ“ Valid snapshot version: $VERSION"

      - name: Override version
        run: |
          VERSION="${{ github.event.inputs.snapshot-version }}"
          echo "Overriding version to: $VERSION"
          sed -i.bak "s/^VERSION=.*/VERSION=$VERSION/" gradle.properties
          cat gradle.properties | grep VERSION

      - name: Run tests
        run: ./gradlew test --no-daemon

      - name: Publish to GitHub Packages
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_ACTOR: ${{ github.actor }}
          SIGNING_GPG_KEY_NAME: ${{ secrets.SIGNING_GPG_KEY_NAME }}
          SIGNING_GPG_PASSPHRASE: ${{ secrets.SIGNING_GPG_PASSPHRASE }}
        run: |
          set -euo pipefail
          SIGNING_ARGS=(-Psigning.gnupg.keyName="$SIGNING_GPG_KEY_NAME")
          if [ -n "${SIGNING_GPG_PASSPHRASE:-}" ]; then
            SIGNING_ARGS+=(-Psigning.gnupg.passphrase="$SIGNING_GPG_PASSPHRASE")
          fi

          run_publish() {
            local attempt="$1"
            set +e
            ./gradlew publishMavenPublicationToGitHubPackagesRepository "${SIGNING_ARGS[@]}" \
              --no-configuration-cache \
              --no-daemon \
              --stacktrace 2>&1 | tee "publish-attempt-${attempt}.log"
            local publish_exit="${PIPESTATUS[0]}"
            set -e
            return "${publish_exit}"
          }

          if run_publish 1; then
            exit 0
          fi

          if grep -Eq "Could not PUT '.*\\.sha1'.*status code 409" publish-attempt-1.log; then
            echo "Detected GitHub Packages checksum conflict (409 on .sha1 upload). Retrying once."
            sleep 10
            run_publish 2
            exit 0
          fi

          echo "Publish failed with a non-retriable error."
          exit 1

      - name: Summary
        run: |
          VERSION="${{ github.event.inputs.snapshot-version }}"
          cat << EOF >> $GITHUB_STEP_SUMMARY
          ## Snapshot Published 

          **Version:** \`$VERSION\`

          \`\`\`kotlin
          dependencies {
              implementation("io.amichne:konditional:$VERSION")
          }
          \`\`\`

          ### GitHub Packages
          \`\`\`kotlin
          repositories {
              maven {
                  url = uri("https://maven.pkg.github.com/amichne/konditional")
                  credentials {
                      username = project.findProperty("gpr.user") as String? ?: System.getenv("USERNAME")
                      password = project.findProperty("gpr.key") as String? ?: System.getenv("TOKEN")
                  }
              }
          }

          dependencies {
              implementation("io.amichne:konditional:$VERSION")
          }
          \`\`\`
          EOF
