name: Cut Release

on:
  workflow_dispatch:
    inputs:
      release-type:
        description: 'SemVer bump: major, minor, or patch'
        required: true
        type: choice
        options:
          - major
          - minor
          - patch

permissions:
  contents: write

jobs:
  cut-release:
    runs-on: ubuntu-latest
    steps:
      - name: Ensure workflow runs on default branch
        if: github.ref_name != github.event.repository.default_branch
        run: |
          echo "This workflow must be dispatched from ${{ github.event.repository.default_branch }}, but got ${{ github.ref_name }}."
          exit 1

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.ref_name }}
          ssh-key: ${{ secrets.RELEASE_DEPLOY_KEY }}
          persist-credentials: true

      - name: Force SSH origin for protected-branch push
        run: git remote set-url origin "git@github.com:${{ github.repository }}.git"

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'gradle'

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Run release automation
        run: |
          ./gradlew release \
            --no-configuration-cache \
            --no-daemon \
            --stacktrace \
            -Prelease.useAutomaticVersion=true \
            -PreleaseType="${{ github.event.inputs.release-type }}"

      - name: Capture release versions
        id: version
        run: |
          STORE_FILE="build/release/tmpVersion.properties"
          if [ ! -f "$STORE_FILE" ]; then
            echo "Missing release version store: $STORE_FILE"
            exit 1
          fi

          RELEASE_VERSION="$(grep '^releaseVersion=' "$STORE_FILE" | cut -d'=' -f2)"
          NEXT_DEV_VERSION="$(grep '^postReleaseVersion=' "$STORE_FILE" | cut -d'=' -f2)"

          if [ -z "$RELEASE_VERSION" ] || [ -z "$NEXT_DEV_VERSION" ]; then
            echo "Unable to parse releaseVersion/postReleaseVersion from $STORE_FILE"
            exit 1
          fi

          RELEASE_TAG="v$RELEASE_VERSION"
          if ! git rev-parse "$RELEASE_TAG" >/dev/null 2>&1; then
            echo "Release tag '$RELEASE_TAG' was not created locally."
            exit 1
          fi

          echo "release=$RELEASE_VERSION" >> "$GITHUB_OUTPUT"
          echo "next=$NEXT_DEV_VERSION" >> "$GITHUB_OUTPUT"
          echo "tag=$RELEASE_TAG" >> "$GITHUB_OUTPUT"

      - name: Summary
        run: |
          cat << EOF >> $GITHUB_STEP_SUMMARY
          ## Release Cut

          **Release type:** \`${{ github.event.inputs.release-type }}\`
          **Release tag:** \`${{ steps.version.outputs.tag }}\`
          **Release version:** \`${{ steps.version.outputs.release }}\`
          **Next development version:** \`${{ steps.version.outputs.next }}\`

          The release plugin pushed release and post-release commits plus tag, which triggers the \`Release\` workflow.
          EOF
