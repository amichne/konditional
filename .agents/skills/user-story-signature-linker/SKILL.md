---
name: user-story-signature-linker
description: Create and maintain user-story-oriented documentation with explicit links to JVM signatures and public-surface context artifacts. Use when writing or updating product stories, acceptance criteria, migration notes, or implementation narratives that must stay synchronized with `signatures/*.sig` (or `.signatures/*.sig`) and support deterministic update checks after code changes.
---

# User story signature linker

## Overview

Use this skill to generate story documentation that is explicitly anchored to
signature symbols so future code changes can be traced and updated with low
drift. Keep documentation generation deterministic and continue execution even
when signature coverage is incomplete.

## Required artifacts

Produce these artifacts for each documentation batch:

1. Story documents (`docs/user-stories/*.md`) using the template in
   `references/story_doc_template.md`.
2. A link map (`docs/user-stories/story-signature-links.json`) following
   `references/story_signature_link_schema.md`.
3. A validation report (`docs/user-stories/story-signature-report.json`)
   generated by `scripts/validate_story_signature_links.py`.

## Workflow

1. Ensure signature artifacts exist.
2. Build public-surface bootstrap context.
3. Draft or update story docs from user stories.
4. Map each story to explicit signatures.
5. Validate links and auto-refresh signature artifacts if links are missing.
6. Continue documentation generation even if some links remain unresolved.
7. Record unresolved links in the report and in each story's "Open questions"
   section.

## Commands

1. Generate or refresh signatures:

```bash
.agents/skills/llm-native-signature-spec/scripts/generate_signatures.sh --repo-root . --output-dir signatures
```

2. Build public-surface context:

```bash
.agents/skills/public-surface-init-context/scripts/build_public_surface_context.py --repo-root . --signatures-dir signatures --output signatures/PUBLIC_SURFACE.ctx
```

3. Validate story/signature link coverage with automatic refresh and
   non-blocking behavior:

```bash
python3 .agents/skills/user-story-signature-linker/scripts/validate_story_signature_links.py \
  --repo-root . \
  --links-file docs/user-stories/story-signature-links.json \
  --report-out docs/user-stories/story-signature-report.json \
  --auto-refresh
```

4. Use `--strict` only when you intentionally want missing links to fail the
   run (for example, CI gating).

## Missing-signature protocol

When a required symbol is not found:

1. Regenerate signatures and public-surface context.
2. Re-run link validation.
3. If still unresolved, keep generating docs and mark the link status as
   `missing`.
4. Add a deterministic gap note with:
   - story id
   - requested symbol
   - search scope (`signatures` or `.signatures`)
   - next action

Do not stop execution solely because one signature link is unresolved.

## Determinism and boundary rules

- Treat user stories and link-map JSON as untrusted boundary input.
- Parse into typed structures (script-backed) before deriving reports.
- Keep ordering stable:
  - sort unresolved findings by `story_id`, then `kind`, then `signature`
  - keep output JSON deterministic (`sort_keys=true`)
- Never add timestamps or random IDs to generated linkage artifacts.

